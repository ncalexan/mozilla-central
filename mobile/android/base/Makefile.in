# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

DEPTH		= @DEPTH@
topsrcdir	= @top_srcdir@
srcdir		= @srcdir@
VPATH		= @srcdir@

include $(DEPTH)/config/autoconf.mk
include $(topsrcdir)/ipc/app/defs.mk

DIST_FILES = package-name.txt

include $(topsrcdir)/mobile/android/base/android-services-files.mk

MOZGLUE_JAVA_FILES := \
  mozglue/ByteBufferInputStream.java \
  mozglue/DirectBufferAllocator.java \
  mozglue/NativeReference.java \
  mozglue/NativeZip.java \
  $(NULL)

MOZGLUE_PP_JAVA_FILES := \
  mozglue/GeckoLoader.java \
  $(NULL)

UTIL_JAVA_FILES := \
  util/ActivityResultHandler.java \
  util/ActivityResultHandlerMap.java \
  util/EventDispatcher.java \
  util/FloatUtils.java \
  util/GamepadUtils.java \
  util/GeckoBackgroundThread.java \
  util/GeckoEventListener.java \
  util/GeckoEventResponder.java \
  util/GeckoJarReader.java \
  util/INIParser.java \
  util/INISection.java \
  util/StringUtils.java \
  util/ThreadUtils.java \
  util/UiAsyncTask.java \
  $(NULL)

FENNEC_JAVA_FILES = \
  ActivityHandlerHelper.java \
  AlertNotification.java \
  AllCapsTextView.java \
  AndroidImport.java \
  AndroidImportPreference.java \
  AnimatorProxy.java \
  AnimatedHeightLayout.java \
  AppNotificationClient.java \
  AwesomeBar.java \
  AwesomebarResultHandler.java \
  AwesomeBarTabs.java \
  awesomebar/AwesomeBarTab.java \
  awesomebar/AllPagesTab.java \
  awesomebar/BookmarksTab.java \
  awesomebar/HistoryTab.java \
  BackButton.java \
  BrowserApp.java \
  BrowserToolbar.java \
  BrowserToolbarBackground.java \
  BrowserToolbarLayout.java \
  CameraImageResultHandler.java \
  CameraVideoResultHandler.java \
  CanvasDelegate.java \
  CheckableLinearLayout.java \
  SyncPreference.java \
  db/BrowserDB.java \
  db/LocalBrowserDB.java \
  db/DBUtils.java \
  Distribution.java \
  Divider.java \
  DoorHanger.java \
  DoorHangerPopup.java \
  Favicons.java \
  FilePickerResultHandler.java \
  FilePickerResultHandlerSync.java \
  FindInPageBar.java \
  FlowLayout.java \
  FontSizePreference.java \
  FormAssistPopup.java \
  ForwardButton.java \
  GeckoAccessibility.java \
  GeckoApplication.java \
  GeckoApp.java \
  GeckoAppShell.java \
  GeckoBatteryManager.java \
  GeckoConnectivityReceiver.java \
  GeckoEditable.java \
  GeckoEvent.java \
  GeckoHalDefines.java \
  GeckoInputConnection.java \
  GeckoMenu.java \
  GeckoMenuInflater.java \
  GeckoMenuItem.java \
  GeckoMessageReceiver.java \
  GeckoSubMenu.java \
  GeckoPreferences.java \
  GeckoProfile.java \
  GeckoPopupMenu.java \
  GeckoThread.java \
  GlobalHistory.java \
  GeckoViewsFactory.java \
  HeightChangeAnimation.java \
  InputMethods.java \
  JavaAddonManager.java \
  LightweightTheme.java \
  LightweightThemeDrawable.java \
  LinkPreference.java \
  MemoryMonitor.java \
  MenuButton.java \
  MenuItemActionBar.java \
  MenuItemDefault.java \
  MenuPanel.java \
  MenuPopup.java \
  MotionEventInterceptor.java \
  MultiChoicePreference.java \
  NotificationClient.java \
  NotificationHandler.java \
  NotificationService.java \
  NSSBridge.java \
  CustomEditText.java \
  PrefsHelper.java \
  PrivateDataPreference.java \
  PrivateTab.java \
  PropertyAnimator.java \
  ProfileMigrator.java \
  PromptService.java \
  sqlite/ByteBufferInputStream.java \
  sqlite/MatrixBlobCursor.java \
  sqlite/SQLiteBridge.java \
  sqlite/SQLiteBridgeException.java \
  ReaderModeUtils.java \
  RemoteTabs.java \
  RobocopAPI.java \
  ServiceNotificationClient.java \
  SessionParser.java \
  SetupScreen.java \
  ShapedButton.java \
  SiteIdentityPopup.java \
  SuggestClient.java \
  SurfaceBits.java \
  Tab.java \
  Tabs.java \
  TabsButton.java \
  TabsPanel.java \
  TabsTray.java \
  TabsAccessor.java \
  TailTouchDelegate.java \
  Telemetry.java \
  TextSelection.java \
  TextSelectionHandle.java \
  ThumbnailHelper.java \
  TouchEventInterceptor.java \
  VideoPlayer.java \
  WebAppAllocator.java \
  ZoomConstraints.java \
  gfx/Axis.java \
  gfx/BitmapUtils.java \
  gfx/BufferedCairoImage.java \
  gfx/CairoGLInfo.java \
  gfx/CairoImage.java \
  gfx/CairoUtils.java \
  gfx/DisplayPortCalculator.java \
  gfx/DisplayPortMetrics.java \
  gfx/DrawTimingQueue.java \
  gfx/FloatSize.java \
  gfx/GeckoLayerClient.java \
  gfx/GfxInfoThread.java \
  gfx/GLController.java \
  gfx/ImmutableViewportMetrics.java \
  gfx/InputConnectionHandler.java \
  gfx/IntSize.java \
  gfx/JavaPanZoomController.java \
  gfx/Layer.java \
  gfx/LayerRenderer.java \
  gfx/LayerView.java \
  gfx/PluginLayer.java \
  gfx/NinePatchTileLayer.java \
  gfx/PanningPerfAPI.java \
  gfx/PanZoomController.java \
  gfx/PanZoomTarget.java \
  gfx/PointUtils.java \
  gfx/ProgressiveUpdateData.java \
  gfx/RectUtils.java \
  gfx/ScrollbarLayer.java \
  gfx/SimpleScaleGestureDetector.java \
  gfx/SingleTileLayer.java \
  gfx/SubdocumentScrollHelper.java \
  gfx/TextLayer.java \
  gfx/TextureGenerator.java \
  gfx/TextureReaper.java \
  gfx/TileLayer.java \
  gfx/TouchEventHandler.java \
  gfx/ViewTransform.java \
  gfx/VirtualLayer.java \
  widget/AboutHomeContent.java \
  widget/AboutHomeSection.java \
  widget/AddonsSection.java \
  widget/DateTimePicker.java \
  widget/IconTabWidget.java \
  widget/LastTabsSection.java \
  widget/LinkTextView.java \
  widget/PromoBox.java \
  widget/RemoteTabsSection.java \
  widget/TopSitesView.java \
  widget/TabRow.java \
  widget/ThumbnailView.java \
  widget/TwoWayView.java \
  GeckoNetworkManager.java \
  GeckoScreenOrientationListener.java \
  UpdateService.java \
  GeckoUpdateReceiver.java \
  ReferrerReceiver.java \
  $(NULL)

ifdef MOZ_WEBSMS_BACKEND
FENNEC_JAVA_FILES += GeckoSmsManager.java
endif

ifdef MOZ_ANDROID_ANR_REPORTER
DEFINES += -DMOZ_ANDROID_ANR_REPORTER=1
FENNEC_JAVA_FILES += ANRReporter.java
endif

FENNEC_PP_JAVA_VIEW_FILES = \
  GeckoButton.java \
  GeckoImageButton.java \
  GeckoImageView.java \
  GeckoEditText.java \
  GeckoFrameLayout.java \
  GeckoLinearLayout.java \
  GeckoRelativeLayout.java \
  GeckoTextSwitcher.java \
  GeckoTextView.java \
  $(NULL)

FENNEC_PP_JAVA_FILES = \
  App.java \
  MarketplaceApp.java \
  WebApp.java \
  WebApps.java \
  GeckoActivity.java \
  GeckoAppInfo.java \
  LauncherShortcuts.java \
  Restarter.java \
  db/BrowserContract.java \
  db/BrowserProvider.java \
  db/PasswordsProvider.java \
  db/FormHistoryProvider.java \
  db/TabsProvider.java \
  db/GeckoProvider.java \
  SmsManager.java \
  UpdateServiceHelper.java \
  $(NULL)

ifneq (,$(findstring -march=armv7,$(OS_CFLAGS)))
MIN_CPU_VERSION=7
else
MIN_CPU_VERSION=5
endif

MOZ_APP_BUILDID=$(shell cat $(DEPTH)/config/buildid)

ifeq (,$(ANDROID_VERSION_CODE))
ifeq ($(MIN_CPU_VERSION),7)
ANDROID_VERSION_CODE=$(shell cat $(DEPTH)/config/buildid | cut -c1-10)
else
# decrement the version code by 1 for armv6 builds so armv7 builds will win any compatability ties
ANDROID_VERSION_CODE=$(shell echo $$((`cat $(DEPTH)/config/buildid | cut -c1-10` - 1)))
endif
endif

UA_BUILDID=$(shell echo $(ANDROID_VERSION_CODE) | cut -c1-8)

MOZ_BUILD_TIMESTAMP=$(shell echo `$(PYTHON) $(topsrcdir)/toolkit/xre/make-platformini.py --print-timestamp`)

# Mangle our package name to avoid Bug 750548.
DEFINES += \
  -DMANGLED_ANDROID_PACKAGE_NAME=$(subst fennec,f3nn3c,$(ANDROID_PACKAGE_NAME)) \
  -DANDROID_PACKAGE_NAME=$(ANDROID_PACKAGE_NAME) \
  -DANDROID_CPU_ARCH=$(ANDROID_CPU_ARCH) \
  -DMOZ_APP_DISPLAYNAME="$(MOZ_APP_DISPLAYNAME)" \
  -DMOZ_APP_NAME=$(MOZ_APP_NAME) \
  -DMOZ_APP_VERSION=$(MOZ_APP_VERSION) \
  -DMOZ_APP_ID=$(MOZ_APP_ID) \
  -DMOZ_CHILD_PROCESS_NAME=$(MOZ_CHILD_PROCESS_NAME) \
  -DMOZ_MIN_CPU_VERSION=$(MIN_CPU_VERSION) \
  -DMOZ_CRASHREPORTER=$(MOZ_CRASHREPORTER) \
  -DMOZ_UPDATE_CHANNEL=$(MOZ_UPDATE_CHANNEL) \
  -DANDROID_VERSION_CODE=$(ANDROID_VERSION_CODE) \
  -DMOZILLA_OFFICIAL=$(MOZILLA_OFFICIAL) \
  -DUA_BUILDID=$(UA_BUILDID) \
  -DMOZ_APP_BASENAME=$(MOZ_APP_BASENAME) \
  -DMOZ_APP_BUILDID=$(MOZ_APP_BUILDID) \
  -DMOZ_APP_ABI=$(TARGET_XPCOM_ABI) \
  -DMOZ_BUILD_TIMESTAMP=$(MOZ_BUILD_TIMESTAMP) \
  -DMOZ_UPDATER=$(MOZ_UPDATER) \
  -DOS_TARGET=$(OS_TARGET) \
  $(NULL)

ifdef MOZ_PKG_SPECIAL
DEFINES += -DMOZ_PKG_SPECIAL=$(MOZ_PKG_SPECIAL)
endif

ifdef MOZ_LINKER_EXTRACT
DEFINES += -DMOZ_LINKER_EXTRACT=1
endif

GARBAGE += \
  AndroidManifest.xml  \
  classes.dex  \
  $(MOZGLUE_PP_JAVA_FILES) \
  $(FENNEC_PP_JAVA_FILES) \
  $(FENNEC_PP_JAVA_VIEW_FILES) \
  $(SYNC_PP_JAVA_FILES) \
  gecko.ap_  \
  res/values/strings.xml \
  R.java \
  package-name.txt \
  Manifest.java \
  javah.out \
  jni-stubs.inc \
  $(NULL)

GARBAGE_DIRS += classes db jars res sync services

MOZ_ANDROID_SHARED_ID = "$(ANDROID_PACKAGE_NAME).sharedID"
MOZ_ANDROID_SHARED_ACCOUNT_TYPE = "$(ANDROID_PACKAGE_NAME)_sync"

# we released these builds to the public with shared IDs and need to keep them
ifeq (org.mozilla.firefox,$(ANDROID_PACKAGE_NAME))
MOZ_ANDROID_SHARED_ID = "org.mozilla.firefox.sharedID"
MOZ_ANDROID_SHARED_ACCOUNT_TYPE = "org.mozilla.firefox_sync"
else ifeq (org.mozilla.firefox_beta,$(ANDROID_PACKAGE_NAME))
MOZ_ANDROID_SHARED_ID = "org.mozilla.firefox.sharedID"
MOZ_ANDROID_SHARED_ACCOUNT_TYPE = "org.mozilla.firefox_sync"
else ifeq (org.mozilla.fennec_aurora,$(ANDROID_PACKAGE_NAME))
MOZ_ANDROID_SHARED_ID = "org.mozilla.fennec.sharedID"
MOZ_ANDROID_SHARED_ACCOUNT_TYPE = "org.mozilla.fennec_sync"
else ifeq (org.mozilla.fennec,$(ANDROID_PACKAGE_NAME))
MOZ_ANDROID_SHARED_ID = "org.mozilla.fennec.sharedID"
MOZ_ANDROID_SHARED_ACCOUNT_TYPE = "org.mozilla.fennec_sync"
endif

ifdef MOZ_ANDROID_SHARED_ID
DEFINES += -DMOZ_ANDROID_SHARED_ID="$(MOZ_ANDROID_SHARED_ID)"
endif
ifdef MOZ_ANDROID_SHARED_ACCOUNT_TYPE
DEFINES += -DMOZ_ANDROID_SHARED_ACCOUNT_TYPE="$(MOZ_ANDROID_SHARED_ACCOUNT_TYPE)"
endif

JAVA_CLASSPATH = $(ANDROID_SDK)/android.jar

ifdef MOZ_CRASHREPORTER
FENNEC_PP_JAVA_FILES += CrashReporter.java
endif

include $(topsrcdir)/config/rules.mk

# Override the Java settings with some specific android settings
include $(topsrcdir)/config/android-common.mk

# Note that we're going to set up a dependency directly between embed_android.dex and the java files
# Instead of on the .class files, since more than one .class file might be produced per .java file
# Sync dependencies are provided in a single jar. Sync classes themselves are delivered as source,
# because Android resource classes must be compiled together in order to avoid overlapping resource
# indices.
classes.dex: jars/gecko-browser.jar
	@echo "DX classes.dex"
	$(DX) --dex --output=classes.dex jars $(ANDROID_COMPAT_LIB)

jars/gecko-browser.jar: jars/gecko-mozglue.jar jars/gecko-util.jar jars/sync-thirdparty.jar $(addprefix $(srcdir)/,$(FENNEC_JAVA_FILES)) $(FENNEC_PP_JAVA_FILES) $(FENNEC_PP_JAVA_VIEW_FILES) $(addprefix $(srcdir)/,$(SYNC_JAVA_FILES)) $(SYNC_PP_JAVA_FILES) R.java
	@echo "JAR gecko-browser.jar"
	$(NSINSTALL) -D classes/gecko-browser
	$(JAVAC) $(JAVAC_FLAGS) -Xlint:all,-deprecation,-fallthrough -d classes/gecko-browser -classpath "jars/gecko-mozglue.jar:jars/gecko-util.jar:jars/sync-thirdparty.jar" $(addprefix $(srcdir)/,$(FENNEC_JAVA_FILES)) $(FENNEC_PP_JAVA_FILES) $(FENNEC_PP_JAVA_VIEW_FILES) $(addprefix $(srcdir)/,$(SYNC_JAVA_FILES)) $(SYNC_PP_JAVA_FILES) R.java
	$(JAR) cMf jars/gecko-browser.jar -C classes/gecko-browser .

jars/gecko-mozglue.jar: $(addprefix $(srcdir)/,$(MOZGLUE_JAVA_FILES)) $(MOZGLUE_PP_JAVA_FILES) jars
	@echo "JAR gecko-mozglue.jar"
	$(NSINSTALL) -D classes/gecko-mozglue
	$(JAVAC) $(JAVAC_FLAGS) -Xlint:all -d classes/gecko-mozglue $(addprefix $(srcdir)/,$(MOZGLUE_JAVA_FILES)) $(MOZGLUE_PP_JAVA_FILES)
	$(JAR) cMf jars/gecko-mozglue.jar -C classes/gecko-mozglue .

jars/gecko-util.jar: jars/gecko-mozglue.jar $(addprefix $(srcdir)/,$(UTIL_JAVA_FILES)) jars
	@echo "JAR gecko-util.jar"
	$(NSINSTALL) -D classes/gecko-util
	$(JAVAC) $(JAVAC_FLAGS) -Xlint:all,-deprecation -d classes/gecko-util -classpath "jars/gecko-mozglue.jar" $(addprefix $(srcdir)/,$(UTIL_JAVA_FILES))
	$(JAR) cMf jars/gecko-util.jar -C classes/gecko-util .

jars/sync-thirdparty.jar: $(addprefix $(srcdir)/,$(SYNC_THIRDPARTY_JAVA_FILES)) jars
	@echo "JAR sync-thirdparty.jar"
	$(NSINSTALL) -D classes/sync-thirdparty
	$(JAVAC) $(JAVAC_FLAGS) -d classes/sync-thirdparty $(addprefix $(srcdir)/,$(SYNC_THIRDPARTY_JAVA_FILES))
	$(JAR) cMf jars/sync-thirdparty.jar -C classes/sync-thirdparty .

jars:
	@echo "MKDIR jars"
	$(NSINSTALL) -D jars

CLASSES_WITH_JNI= \
    org.mozilla.gecko.GeckoAppShell \
    $(NULL)

ifdef MOZ_WEBSMS_BACKEND
# Note: if you are building with MOZ_WEBSMS_BACKEND turned on, then
# you will get a build error because the generated jni-stubs.inc will
# be different than the one checked in (i.e. it will have the sms-related
# JNI stubs as well). Just copy the generated file to mozglue/android/
# like the error message says and rebuild. All should be well after that.
CLASSES_WITH_JNI += org.mozilla.gecko.GeckoSmsManager
endif

jni-stubs.inc: jars/gecko-browser.jar jars/gecko-mozglue.jar jars/gecko-util.jar jars/sync-thirdparty.jar
	$(JAVAH) -o javah.out -bootclasspath $(JAVA_BOOTCLASSPATH) -classpath $(subst $(NULL) $(NULL),:,$^) $(CLASSES_WITH_JNI)
	$(PYTHON) $(topsrcdir)/mobile/android/base/jni-generator.py javah.out $@

# AndroidManifest.xml includes these files, so they need to be marked as dependencies.
SERVICES_MANIFEST_FRAGMENTS = $(wildcard $(topsrcdir)/mobile/android/services/manifests/*.in)

android-tgts = \
  AndroidManifest.xml \
  $(MOZGLUE_PP_JAVA_FILES) \
  $(FENNEC_PP_JAVA_FILES) \
  $(SYNC_PP_JAVA_FILES) \
  package-name.txt \
  $(NULL)

android-preqs = \
  Makefile.in \
  $(call mkdir_deps,$(sort $(dir $(MOZGLUE_PP_JAVA_FILES)))) \
  $(call mkdir_deps,$(sort $(dir $(FENNEC_PP_JAVA_FILES)))) \
  $(call mkdir_deps,$(sort $(dir $(SYNC_PP_JAVA_FILES)))) \
  $(SERVICES_MANIFEST_FRAGMENTS) \
  WebAppManifestFragment.xml.in \
  WebAppsFragments.java \
  $(NULL)

$(android-tgts): % : %.in $(android-preqs)
	$(PYTHON) $(topsrcdir)/config/Preprocessor.py \
             $(AUTOMATION_PPARGS) -DOBJDIR="`pwd`" $(DEFINES) $(ACDEFINES) $< > $@

# Add a predefined number of WebApp<num> classes to the WebApps class.
# These are used so that each webapp can launch in its own process
# Keep this number in sync with the max web apps in WebAppAllocator.java
NUM_WEB_APPS=100
WebAppManifestFragment.xml.in: WebAppManifestFragment.xml.frag
	@rm -f $@
	@for n in `$(PYTHON) -c "for x in range($(NUM_WEB_APPS)): print x"`; do \
		cat $< | sed s,@APPNUM@,$$n,g >> $@ ; \
	done

WebAppsFragments.java: WebAppsFragment.java.frag
	@rm -f $@
	@for n in `$(PYTHON) -c "for x in range($(NUM_WEB_APPS)): print x"`; do \
		cat $< | sed s,@APPNUM@,$$n,g >> $@ ; \
	done

# Replace @VIEWTYPE@ with different View names.
$(FENNEC_PP_JAVA_VIEW_FILES): GeckoView.java.frag
	@rm -f $@
	cat $< | sed s,@VIEWTYPE@,$(patsubst Gecko%.java,%,$@),g >> $@ ; \

R.java: $(ANDROID_PACKAGE_RESOURCES)
R.java: res/values/strings.xml
R.java: AndroidManifest.xml
R.java: FORCE
	@echo "AAPT R.java"
	$(AAPT) package -f -M AndroidManifest.xml -I $(ANDROID_SDK)/android.jar -S res -J . --custom-package org.mozilla.gecko

gecko.ap_: $(ANDROID_PACKAGE_RESOURCES)
gecko.ap_: res/values/strings.xml
gecko.ap_: AndroidManifest.xml
gecko.ap_: FORCE
	@echo "AAPT gecko.ap_"
	$(AAPT) package -f -M AndroidManifest.xml -I $(ANDROID_SDK)/android.jar -S res -F $@

libs:: classes.dex package-name.txt jni-stubs.inc
	$(INSTALL) classes.dex $(FINAL_TARGET)
	$(INSTALL) package-name.txt $(FINAL_TARGET)
	@(diff jni-stubs.inc $(topsrcdir)/mozglue/android/jni-stubs.inc >/dev/null) || \
	 (echo "*** Error: The jni-stubs have changed. Copy $(CURDIR)/jni-stubs.inc to $(topsrcdir)/mozglue/android" && exit 1)
